<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calon Mantu: Social v3</title>
    <style>
        /* --- CSS LENGKAP (AGAR TAMPILAN TIDAK PUTIH POLOS) --- */
        body { margin: 0; padding: 0; background-color: #0f1c2e; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100dvh; color: white; }
        #app-container { position: relative; width: 100%; max-width: 500px; height: 100%; background: #131d2a; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* LOBBY DESIGN */
        #screen-lobby { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #091320 0%, #1c2a3f 100%); display: none; flex-direction: column; z-index: 1000; }
        .lobby-header { padding: 20px; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .profile-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #f1c40f; }
        .coin-display { margin-left: auto; background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px; border: 1px solid #f39c12; color: #f1c40f; font-weight: bold; font-size: 14px; }

        /* BUTTONS */
        .footer-btn { background: #3498db; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .mode-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; display: flex; align-items: center; cursor: pointer; }

        /* INVITE LIST */
        .player-item { display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-plus { background: #2ecc71; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; font-weight: bold; cursor: pointer; }

        /* GAME BOARD POSITIONS */
        .avatar-game { position: absolute; top: 7.7%; width: 12%; aspect-ratio: 1/1; border-radius: 50%; transform: translate(-50%, -50%); background-size: cover; border: 2px solid white; z-index: 5; }
        #p1-av { left: 16.5%; } #p2-av { left: 83.5%; }
        .stat-box { position: absolute; top: 8.5%; transform: translate(-50%, -50%); width: 14%; text-align: center; font-size: 1.6vh; font-weight: 900; color: #5d4037; z-index: 6; }
        #ui-hati { left: 36.5%; } #ui-uang { left: 66.5%; }

        /* INVITE MODAL */
        #invite-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .invite-box { background: #1c2a3f; padding: 30px; border-radius: 20px; width: 70%; text-align: center; border: 2px solid #f1c40f; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="screen-lobby">
        <div class="lobby-header">
            <img id="user-photo" src="" class="profile-img">
            <div><h4 id="user-name" style="margin:0;">Loading...</h4><small>Online</small></div>
            <div class="coin-display">üí∞ <span id="user-coin">0</span></div>
        </div>

        <div style="display:flex; padding:10px 20px; gap:10px;">
            <button class="footer-btn" id="btn-tab-play" onclick="switchTab('play')" style="flex:1;">MODE MAIN</button>
            <button class="footer-btn" id="btn-tab-online" onclick="switchTab('online')" style="flex:1; background:rgba(255,255,255,0.1);">ONLINE (+)</button>
        </div>

        <div id="tab-play" style="padding:20px; display:flex; flex-direction:column; gap:15px;">
            <div class="mode-card" onclick="startBotMode()" style="border-left:5px solid #3498db;">
                <div style="font-size:30px; margin-right:15px;">ü§ñ</div>
                <div><h4 style="margin:0;">LATIHAN BOT</h4><small>Main Offline</small></div>
            </div>
        </div>

        <div id="tab-online" style="padding:20px; display:none; flex-direction:column; overflow-y:auto;">
            <div id="online-list"></div>
        </div>
    </div>

    <div id="invite-modal">
        <div class="invite-box">
            <img id="inviter-photo" src="" style="width:60px; height:60px; border-radius:50%;">
            <h3 id="inviter-name" style="color:white;">Nama</h3>
            <p>Mengajak Duel!</p>
            <div style="display:flex; gap:10px;">
                <button onclick="acceptInvite()" style="flex:1; padding:10px; background:#2ecc71; border:none; border-radius:8px; color:white; font-weight:bold;">TERIMA</button>
                <button onclick="rejectInvite()" style="flex:1; padding:10px; background:#e74c3c; border:none; border-radius:8px; color:white; font-weight:bold;">TOLAK</button>
            </div>
        </div>
    </div>

    <div id="screen-game" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:url('https://res.cloudinary.com/dsutaioqw/image/upload/v1770514507/board_gukevw.png') center/contain no-repeat;">
        <button onclick="location.reload()" style="position:absolute; top:20px; left:20px; z-index:100;">üè†</button>
        <div id="p1-av" class="avatar-game"></div><div id="p2-av" class="avatar-game"></div>
        <div id="ui-hati" class="stat-box">0</div><div id="ui-uang" class="stat-box">20</div>
    </div>
</div>

<script type="module">
    // --- Pastikan Import Firebase Anda Ada Di Sini ---
    
    window.switchTab = (t) => {
        document.getElementById('tab-play').style.display = t==='play'?'flex':'none';
        document.getElementById('tab-online').style.display = t==='online'?'flex':'none';
        document.getElementById('btn-tab-play').style.background = t==='play'?'#3498db':'rgba(255,255,255,0.1)';
        document.getElementById('btn-tab-online').style.background = t==='online'?'#3498db':'rgba(255,255,255,0.1)';
    };

    // Fungsi List Online dengan tombol Invite (+)
    function listenOnline() {
        onValue(ref(db, 'status'), (snap) => {
            const list = document.getElementById('online-list');
            list.innerHTML = "";
            snap.forEach((child) => {
                if(child.key !== currentUser.uid) {
                    const p = child.val();
                    const div = document.createElement('div');
                    div.className = "player-item";
                    div.innerHTML = `
                        <img src="${p.photo}" style="width:35px; height:35px; border-radius:50%; margin-right:10px;">
                        <div style="flex-grow:1;"><b>${p.name}</b><br><small style="color:#2ecc71;">Online</small></div>
                        <button class="btn-plus" onclick="sendInvite('${child.key}', '${p.name}')">+</button>
                    `;
                    list.appendChild(div);
                }
            });
        });
    }

    // Fungsi mengundang teman
    window.sendInvite = (uid, name) => {
        const rid = "INV_" + Date.now();
        set(ref(db, 'invites/' + uid), { fromName: userStats.name, fromPhoto: userStats.photo, roomId: rid });
        alert("Mengundang " + name + "...");
        joinGameAuto(rid, 'p1');
    };

    function listenInvites() {
        onValue(ref(db, 'invites/' + currentUser.uid), (snap) => {
            if(snap.exists()) {
                const d = snap.val();
                window.activeInvite = d;
                document.getElementById('inviter-name').innerText = d.fromName;
                document.getElementById('inviter-photo').src = d.fromPhoto;
                document.getElementById('invite-modal').style.display = 'flex';
            }
        });
    }

    window.acceptInvite = () => {
        const d = window.activeInvite;
        remove(ref(db, 'invites/' + currentUser.uid));
        document.getElementById('invite-modal').style.display = 'none';
        joinGameAuto(d.roomId, 'p2');
    };
</script>
</body>
</html>
