<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calon Mantu Idaman - Online PvP</title>
    <style>
        /* --- CSS SAMA SEPERTI SEBELUMNYA (VISUAL FINAL) --- */
        body { margin: 0; padding: 0; background-color: #222; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100dvh; user-select: none; }
        #game-container { position: relative; height: 100%; aspect-ratio: 9/16; background-image: url('https://res.cloudinary.com/dsutaioqw/image/upload/v1770514507/board_gukevw.png'); background-size: contain; background-repeat: no-repeat; background-position: center; box-shadow: 0 0 30px rgba(0,0,0,0.8); }

        /* AVATAR (Posisi Fix 5%) */
        .avatar-box { position: absolute; top: 7.3%; width: 13.5%; aspect-ratio: 1/1; border-radius: 50%; transform: translate(-50%, -50%); background-color: #ddd; background-size: cover; border: 2px solid white; z-index: 5; transition: transform 0.3s; }
        .active-turn { transform: translate(-50%, -50%) scale(1.15); border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        #p1-avatar { left: 16.5%; background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix&backgroundColor=ffdfbf'); } 
        #p2-avatar { left: 83.5%; background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Grandma&backgroundColor=b6e3f4'); } 

        /* STATS */
        .stat-box { position: absolute; top: 7.3%; transform: translate(-50%, -50%); width: 16%; text-align: center; font-size: 2.1vh; font-weight: 800; color: #5d4037; z-index: 6; letter-spacing: -0.5px; }
        #ui-hati { left: 36.0%; } 
        #ui-uang { left: 66.0%; } 

        /* BIDAK */
        .pion { position: absolute; width: 7%; aspect-ratio: 1/1; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 5px 10px rgba(0,0,0,0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 10; transform: translate(-50%, -50%); }
        #p1-token { background: #3498db; }
        #p2-token { background: #e74c3c; transform: translate(-30%, -30%) scale(0.8); }

        /* TOAST & MODALS */
        #toast-container { position: absolute; top: 18%; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 5px; align-items: center; z-index: 99; width: 80%; pointer-events: none; }
        .toast-msg { background: rgba(0,0,0,0.85); color: white; padding: 8px 16px; border-radius: 20px; font-size: 1.6vh; animation: fadeInOut 2.5s forwards; border: 1px solid rgba(255,255,255,0.2); }
        @keyframes fadeInOut { 0% {opacity:0; transform:translateY(-10px);} 10% {opacity:1; transform:translateY(0);} 90% {opacity:1;} 100% {opacity:0; display:none;} }

        /* CONTROLS */
        .btn-area { position: absolute; z-index: 20; cursor: pointer; border-radius: 15px; }
        #btn-kocok { bottom: 3.5%; left: 50%; transform: translateX(-50%); width: 42%; height: 10%; border-radius: 40px; }
        #turn-bar { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); background: #3498db; color: white; padding: 5px 20px; border-radius: 15px; font-size: 1.8vh; font-weight: bold; z-index: 30; transition: 0.3s; }

        /* LOBBY SCREEN (NEW) */
        #lobby-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; backdrop-filter: blur(10px);
        }
        .lobby-box { background: white; padding: 30px; border-radius: 20px; color: #333; text-align: center; width: 70%; max-width: 300px; }
        input { padding: 10px; font-size: 16px; width: 80%; margin-bottom: 10px; text-align: center; border: 2px solid #ddd; border-radius: 8px; }
        .role-btn { display: block; width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-p1 { background: #3498db; }
        .btn-p2 { background: #e74c3c; }

    </style>
</head>
<body>

<div id="game-container">
    
    <div id="lobby-screen">
        <div class="lobby-box">
            <h2>MAIN ONLINE</h2>
            <p>Masukkan Kode Room yang sama dengan temanmu:</p>
            <input type="text" id="room-input" placeholder="Contoh: MANTU1" value="ROOM1">
            <p>Pilih Peran:</p>
            <button class="role-btn btn-p1" onclick="joinGame('p1')">ðŸ”µ JADI KAMU (P1)</button>
            <button class="role-btn btn-p2" onclick="joinGame('p2')">ðŸ”´ JADI TEMAN (P2)</button>
        </div>
    </div>

    <div id="p1-avatar" class="avatar-box"></div>
    <div id="p2-avatar" class="avatar-box"></div>
    
    <div id="ui-hati" class="stat-box">0</div>
    <div id="ui-uang" class="stat-box">20</div>

    <div id="p1-token" class="pion"></div>
    <div id="p2-token" class="pion"></div>

    <div id="toast-container"></div>
    <div id="turn-bar">Menunggu Lawan...</div>
    
    <div id="btn-kocok" class="btn-area" onclick="handleRollDice()"></div>
</div>

<script type="module">
    // 1. IMPORT FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // 2. CONFIG ANDA
    const firebaseConfig = {
        apiKey: "AIzaSyCF0Zn-DSK6z3x_4ETIcAwweHk5tR_bpn0",
        authDomain: "mantu-1f6f4.firebaseapp.com",
        projectId: "mantu-1f6f4",
        storageBucket: "mantu-1f6f4.firebasestorage.app",
        messagingSenderId: "674923969086",
        appId: "1:674923969086:web:ffb34307261bbfae74af6f",
        measurementId: "G-W2N2YVDTST"
    };

    // 3. INIT FIREBASE
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 4. GAME VARIABLES
    let myRole = ""; // 'p1' atau 'p2'
    let roomId = "";
    let isMyTurn = false;
    
    // Default State
    let gameState = {
        turn: 'p1', // Giliran siapa
        p1: { pos: 0, uang: 20, hati: 0, omelan: 0, jailed: false },
        p2: { pos: 0, uang: 20, hati: 0, omelan: 0, jailed: false }
    };

    // KOORDINAT GRID (Sama seperti sebelumnya)
    const tiles = [
        { id: 0, x: 11.0, y: 68.3 }, { id: 1, x: 30.5, y: 68.3 }, { id: 2, x: 50.0, y: 68.3 }, { id: 3, x: 69.5, y: 68.3 },
        { id: 4, x: 89.0, y: 68.3 }, { id: 5, x: 89.0, y: 57.1 }, { id: 6, x: 89.0, y: 45.8 }, { id: 7, x: 89.0, y: 34.5 },
        { id: 8, x: 89.0, y: 23.2 }, { id: 9, x: 69.5, y: 23.2 }, { id: 10, x: 50.0, y: 23.2 }, { id: 11, x: 30.5, y: 23.2 },
        { id: 12, x: 11.0, y: 23.2 }, { id: 13, x: 11.0, y: 34.5 }, { id: 14, x: 11.0, y: 45.8 }, { id: 15, x: 11.0, y: 57.1 }
    ];

    // --- FUNGSI JOIN GAME ---
    window.joinGame = (role) => {
        const input = document.getElementById('room-input').value.toUpperCase();
        if(!input) return alert("Masukkan Nama Room!");

        roomId = input;
        myRole = role;

        // Sembunyikan Lobby
        document.getElementById('lobby-screen').style.display = 'none';

        // Connect ke DB
        const roomRef = ref(db, 'rooms/' + roomId);

        // Listener: Setiap ada perubahan di DB, update layar
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                gameState = data;
                updateScreen();
            } else {
                // Room baru, buat data awal
                set(roomRef, gameState);
            }
        });

        pushToast(`Bergabung sebagai ${role === 'p1' ? 'P1 (KAMU)' : 'P2 (TEMAN)'}`);
    };

    // --- FUNGSI TOMBOL KOCOK DADU ---
    window.handleRollDice = () => {
        // Cek apakah giliran saya?
        if (gameState.turn !== myRole) {
            pushToast("Bukan giliranmu!");
            return;
        }

        // Logic Dadu
        const dadu = Math.floor(Math.random() * 6) + 1;
        pushToast(`Dadu: ${dadu}`);

        // Update State Lokal Dulu (Simulasi Gerak)
        let currentUser = gameState[myRole];
        let steps = 0;
        
        // Animasi Loop Sederhana
        let interval = setInterval(() => {
            currentUser.pos++;
            if(currentUser.pos >= 16) {
                currentUser.pos = 0;
                currentUser.uang += 10;
            }
            // Update Visual Lokal sementara
            updatePionLocal(myRole, currentUser.pos);
            steps++;

            if(steps >= dadu) {
                clearInterval(interval);
                // FINALISASI: Update ke Database (Server)
                finishTurn(currentUser);
            }
        }, 200);
    };

    function finishTurn(playerData) {
        // Simple Effect Logic (Bisa dikembangkan)
        // Disini kita update data final ke server
        
        // Ganti Giliran
        const nextTurn = (gameState.turn === 'p1') ? 'p2' : 'p1';

        // Update object gameState
        gameState[myRole] = playerData;
        gameState.turn = nextTurn;

        // KIRIM KE FIREBASE
        const updates = {};
        updates['/rooms/' + roomId] = gameState;
        update(ref(db), updates);
    }

    // --- UPDATE TAMPILAN (DARI DATA SERVER) ---
    function updateScreen() {
        // 1. Posisi Bidak
        updatePionLocal('p1', gameState.p1.pos);
        updatePionLocal('p2', gameState.p2.pos);

        // 2. Stats (Tampilkan stat siapa yang sedang aktif / stat diri sendiri)
        // Agar adil, tampilkan stat diri sendiri di kotak atas
        const myStats = gameState[myRole]; 
        document.getElementById('ui-uang').innerText = myStats ? myStats.uang : 0;
        document.getElementById('ui-hati').innerText = myStats ? myStats.hati : 0;

        // 3. Indikator Giliran
        const bar = document.getElementById('turn-bar');
        if (gameState.turn === myRole) {
            bar.innerText = "GILIRAN KAMU!";
            bar.style.background = (myRole === 'p1') ? '#3498db' : '#e74c3c';
            document.getElementById('btn-kocok').style.pointerEvents = 'auto'; // Aktifkan tombol
        } else {
            bar.innerText = "MENUNGGU LAWAN...";
            bar.style.background = '#7f8c8d';
            document.getElementById('btn-kocok').style.pointerEvents = 'none'; // Matikan tombol
        }

        // Highlight Avatar
        const p1Box = document.getElementById('p1-avatar');
        const p2Box = document.getElementById('p2-avatar');
        
        if (gameState.turn === 'p1') {
            p1Box.classList.add('active-turn');
            p2Box.classList.remove('active-turn');
        } else {
            p1Box.classList.remove('active-turn');
            p2Box.classList.add('active-turn');
        }
    }

    function updatePionLocal(role, posIndex) {
        if(posIndex >= tiles.length) posIndex = 0;
        const coord = tiles[posIndex];
        const el = document.getElementById(role === 'p1' ? 'p1-token' : 'p2-token');
        if(el) {
            el.style.left = coord.x + "%";
            el.style.top = coord.y + "%";
        }
    }

    function pushToast(msg) {
        let div = document.createElement('div');
        div.className = "toast-msg";
        div.innerText = msg;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(() => div.remove(), 2600);
    }

</script>
</body>
</html>
