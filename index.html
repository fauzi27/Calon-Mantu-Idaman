<div id="screen-lobby">
    <div class="lobby-header">
        <div class="profile-frame"><img id="user-photo" src="" class="profile-img"></div>
        <div class="profile-info">
            <h3 id="user-name">Loading...</h3>
            <p>Pejuang Restu â€¢ Online</p>
        </div>
        <div class="coin-display">ðŸ’° <span id="user-coin">0</span></div>
    </div>

    <div style="display:flex; padding:10px 20px; gap:10px;">
        <button class="footer-btn" id="tab-play-btn" onclick="switchTab('play')" style="flex:1; background:#3498db;">MODE MAIN</button>
        <button class="footer-btn" id="tab-online-btn" onclick="switchTab('online')" style="flex:1; background:rgba(255,255,255,0.1);">ONLINE (+)</button>
    </div>

    <div id="tab-play" style="padding:20px; display:flex; flex-direction:column; gap:15px;">
        <div class="mode-card" onclick="startBotMode()" style="border-left:5px solid #3498db; height:80px;">
            <div style="font-size:30px; margin-right:15px;">ðŸ¤–</div>
            <div><h4>LATIHAN BOT</h4><small>Main Offline</small></div>
        </div>
        <p style="text-align:center; color:#7f8c8d; font-size:12px;">Pindah ke tab <b>ONLINE</b> untuk undang teman langsung.</p>
    </div>

    <div id="tab-online" style="padding:20px; display:none; flex-direction:column; gap:10px; overflow-y:auto; flex-grow:1;">
        <div id="online-list">
            </div>
    </div>

    <div class="lobby-footer">
        <button class="footer-btn" onclick="logout()" style="grid-column: span 2; background:rgba(231, 76, 60, 0.2);">GANTI AKUN</button>
    </div>
</div>

<div id="invite-modal" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:none; flex-direction:column; justify-content:center; align-items:center;">
    <div style="background:#1c2a3f; padding:30px; border-radius:20px; width:70%; text-align:center; border:2px solid #f1c40f;">
        <img id="inviter-photo" src="" style="width:70px; height:70px; border-radius:50%; border:2px solid white;">
        <h3 id="inviter-name" style="color:white; margin:10px 0;">Nama</h3>
        <p style="color:#bdc3c7;">Mengajak duel restu!</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="acceptInvite()" style="flex:1; padding:12px; background:#2ecc71; border:none; border-radius:10px; color:white; font-weight:bold;">TERIMA</button>
            <button onclick="rejectInvite()" style="flex:1; padding:12px; background:#e74c3c; border:none; border-radius:10px; color:white; font-weight:bold;">TOLAK</button>
        </div>
    </div>
</div>

<script type="module">
    /* ... (Import Firebase Anda yang sudah ada) ... */

    // FUNGSI SWITCH TAB
    window.switchTab = (target) => {
        document.getElementById('tab-play').style.display = (target === 'play') ? 'flex' : 'none';
        document.getElementById('tab-online').style.display = (target === 'online') ? 'flex' : 'none';
        document.getElementById('tab-play-btn').style.background = (target === 'play') ? '#3498db' : 'rgba(255,255,255,0.1)';
        document.getElementById('tab-online-btn').style.background = (target === 'online') ? '#3498db' : 'rgba(255,255,255,0.1)';
    };

    // FUNGSI LIST ONLINE DENGAN TOMBOL PLUS (+)
    function listenOnlinePlayers() {
        onValue(ref(db, 'status'), (snapshot) => {
            const listDiv = document.getElementById('online-list');
            listDiv.innerHTML = "";
            snapshot.forEach((child) => {
                if(child.key !== currentUser.uid) { // Jangan tampilkan diri sendiri
                    const p = child.val();
                    const item = document.createElement('div');
                    item.style = "display:flex; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; margin-bottom:8px;";
                    item.innerHTML = `
                        <img src="${p.photo}" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                        <div style="flex-grow:1;">
                            <b style="font-size:14px; color:white;">${p.name}</b><br>
                            <small style="color:#2ecc71;">Online</small>
                        </div>
                        <button onclick="sendInvite('${child.key}', '${p.name}')" style="background:#3498db; color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:20px; font-weight:bold; cursor:pointer;">+</button>
                    `;
                    listDiv.appendChild(item);
                }
            });
        });
    }

    // FUNGSI KIRIM INVITE
    window.sendInvite = (targetUid, targetName) => {
        const autoRoomId = "INV_" + currentUser.uid.substring(0,5) + "_" + Date.now();
        const inviteData = {
            fromName: userStats.name,
            fromPhoto: userStats.photo,
            roomId: autoRoomId
        };
        set(ref(db, 'invites/' + targetUid), inviteData);
        pushToast(`Menunggu ${targetName}...`);
        joinGameAuto(autoRoomId, 'p1'); // Penantang jadi P1
    };

    // FUNGSI TERIMA INVITE
    function listenForInvites() {
        onValue(ref(db, 'invites/' + currentUser.uid), (snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                window.incomingInvite = data;
                document.getElementById('inviter-name').innerText = data.fromName;
                document.getElementById('inviter-photo').src = data.fromPhoto;
                document.getElementById('invite-modal').style.display = 'flex';
            }
        });
    }

    window.acceptInvite = () => {
        const data = window.incomingInvite;
        remove(ref(db, 'invites/' + currentUser.uid));
        document.getElementById('invite-modal').style.display = 'none';
        joinGameAuto(data.roomId, 'p2'); // Penerima jadi P2
    };

    window.rejectInvite = () => {
        remove(ref(db, 'invites/' + currentUser.uid));
        document.getElementById('invite-modal').style.display = 'none';
    };

    function joinGameAuto(rId, role) {
        roomId = rId; myRole = role;
        document.getElementById('screen-lobby').style.display = 'none';
        document.getElementById('screen-game').style.display = 'block';
        // ... (Sisa logika joinGame Anda yang lama tetap sama)
    }

    /* Panggil listenOnlinePlayers() dan listenForInvites() di dalam onAuthStateChanged */
</script>
