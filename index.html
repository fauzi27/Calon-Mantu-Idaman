<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calon Mantu: Final v17</title>
    <style>
        /* --- 1. SETUP --- */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        body{margin:0;padding:0;background:#0f1c2e;font-family:'Fredoka',sans-serif;overflow:hidden;display:flex;justify-content:center;align-items:center;height:100dvh;color:#fff;user-select:none;}
        #app{position:relative;width:100%;max-width:500px;height:100%;background:#131d2a;overflow:hidden;box-shadow:0 0 50px #000;}
        
        .screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;}
        .bg-board { background: url('https://res.cloudinary.com/dsutaioqw/image/upload/v1770557809/utama_l86cnu.png') center/100% 100% no-repeat; }

        /* --- 2. LOGIN BARU --- */
        #sc-login { background: radial-gradient(circle at center, #1e3c72 0%, #2a5298 100%); z-index: 2000; justify-content: center; align-items: center; text-align: center; }
        .hero-title { font-size: 48px; margin-bottom: 20px; background: linear-gradient(to bottom, #f1c40f, #d35400); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 0 #5e3004); transform: rotate(-3deg); }
        .btn-g { background: white; color: #333; padding: 12px 35px; border-radius: 50px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; }

        /* --- 3. LOBBY & SOCIAL LIST --- */
        #sc-lobby{background:linear-gradient(135deg,#091320,#1c2a3f);z-index:10; overflow-y:auto;}
        
        /* Box Daftar Pemain */
        .social-box {
            background: rgba(0,0,0,0.3); margin: 10px 20px; border-radius: 15px; 
            border: 1px solid rgba(255,255,255,0.1); max-height: 180px; display: flex; flex-direction: column;
        }
        .social-header { padding: 10px; background: rgba(255,255,255,0.05); border-radius: 15px 15px 0 0; font-size: 12px; font-weight: bold; color: #ccc; }
        .player-list { overflow-y: auto; flex: 1; padding: 5px; }
        .p-item { 
            display: flex; align-items: center; padding: 8px; margin-bottom: 5px; 
            background: rgba(255,255,255,0.05); border-radius: 10px; transition: 0.2s;
        }
        .p-item img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 2px solid #555; }
        .p-item .stat-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; margin-right: 5px; }
        .p-item.on .stat-dot { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .p-item .inv-btn { margin-left: auto; background: #3498db; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .p-item .inv-btn:active { transform: scale(0.9); }

        /* --- 4. GAME BOARD --- */
        #game-header { position: absolute; top: 2%; left: 2%; width: 96%; height: 15%; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .p-card { width: 32%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .pc-av { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 2px; object-fit: cover; background: #555; transition: 0.3s; }
        .active-glow { border-color: #f1c40f; box-shadow: 0 0 25px #f1c40f; transform: scale(1.15); z-index: 20; }
        .pc-stats { display: flex; gap: 3px; font-size: 9px; font-weight: bold; }
        .st-val { background: rgba(0,0,0,0.6); padding: 2px 5px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; }

        /* PION TENGAH & JUMPING FIX */
        .pion { 
            position: absolute; width: 6%; aspect-ratio: 1/1; 
            border-radius: 50%; border: 2px solid #fff; 
            box-shadow: 0 5px 10px rgba(0,0,0,0.5); display: none; z-index: 15; 
            background-size: cover; background-position: center;
            transform: translate(-50%, -50%); /* Posisi Tengah Sempurna */
        }
        #p1-tok { border-color: #3498db; } #p2-tok { border-color: #e74c3c; } #p3-tok { border-color: #2ecc71; }
        
        .jumping { animation: jump 0.5s ease-in-out; }
        @keyframes jump { 
            0% { transform: translate(-50%, -50%) scale(1); } 
            50% { transform: translate(-50%, -150%) scale(1.3); } 
            100% { transform: translate(-50%, -50%) scale(1); } 
        }

        /* CONTROLS (NAIK 1.5%) */
        #turn-txt { 
            position: absolute; bottom: 19.5%;
            left: 50%; transform: translateX(-50%); 
            background: #3498db; padding: 8px 30px; border-radius: 30px; 
            font-weight: bold; font-size: 14px; box-shadow: 0 3px 15px #000; 
            text-align: center; border: 2px solid white; z-index: 20;
        }
        .btn-hide { position: absolute; bottom: 3.5%; width: 25%; height: 9%; cursor: pointer; z-index: 20; background: transparent; border: none; }
        #btn-kocok { left: 50%; transform: translateX(-50%); width: 38%; height: 10%; bottom: 3%; border-radius: 40px; background: transparent; border: none; }
        #btn-kartu { left: 4%; } #btn-info { right: 4%; }

        /* CHAT (NAIK SEDIKIT) */
        #chat-btn { position: absolute; bottom: 140px; right: 20px; width: 50px; height: 50px; background: #2ecc71; border-radius: 50%; border: 2px solid #fff; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 90; box-shadow: 0 4px 10px #000; }
        #chat-box { position: absolute; bottom: 200px; right: 20px; width: 200px; display: none; z-index: 95; }
        #chat-in { width: 70%; padding: 8px; border-radius: 5px; border:none; outline:none; }
        .chat-b { position: absolute; padding: 5px 10px; background: white; color: #000; border-radius: 10px; font-size: 10px; font-weight: bold; display: none; transform: translate(-50%, -160%); box-shadow: 0 2px 5px #000; z-index: 100; text-align: center; min-width: 60px; }

        /* INFO POP-UP */
        #info-bubble {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: rgba(0,0,0,0.95); padding: 15px 30px; border-radius: 20px;
            color: #f1c40f; font-weight: bold; font-size: 16px; border: 2px solid #fff;
            z-index: 200; pointer-events: none; text-align: center; box-shadow: 0 0 30px rgba(241,196,15,0.5);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #info-bubble.show { transform: translate(-50%, -50%) scale(1); }

        /* LOBBY */
        .edit-prof { display: flex; flex-direction: column; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 10px; }
        .edit-av { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #f1c40f; object-fit: cover; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; width: 100%; box-sizing: border-box; }
        .mode-btn { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: 0.2s; text-align: center; }
        .mode-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .big-btn { grid-column: span 2; background: linear-gradient(45deg, #2980b9, #3498db); border: none; }
        .shop-btn { background: linear-gradient(45deg, #e67e22, #f39c12); border: none; }
        .inv-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); border: none; }

        /* MODAL */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; display: none; justify-content: center; align-items: center; }
        .box { background: #1c2a3f; padding: 25px; border-radius: 20px; width: 80%; text-align: center; border: 2px solid #f1c40f; max-height: 80%; overflow-y: auto; }
        
        /* DICE */
        #dice-scn{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;display:none;z-index:50;}
        .cube{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 1s;}
        .face{position:absolute;width:80px;height:80px;background:#fff;border:2px solid #ccc;border-radius:10px;display:flex;justify-content:center;align-items:center;font-size:40px;color:#333;}
        .f1{transform:rotateY(0deg) translateZ(40px);} .f2{transform:rotateY(90deg) translateZ(40px);} .f3{transform:rotateY(180deg) translateZ(40px);}
        .f4{transform:rotateY(-90deg) translateZ(40px);} .f5{transform:rotateX(90deg) translateZ(40px);} .f6{transform:rotateX(-90deg) translateZ(40px);}
        
        #toast{position:absolute;top:25%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:5px;align-items:center;z-index:150;width:90%;pointer-events:none;}
        .t-msg{background:rgba(0,0,0,0.9);color:#fff;padding:10px 20px;border-radius:25px;font-size:13px;animation:fade 3s forwards;border:1px solid #f1c40f; text-align: center;}
        @keyframes fade{0%{opacity:0;transform:translateY(-10px);}10%{opacity:1;transform:translateY(0);}90%{opacity:1;}100%{opacity:0;display:none;}}
    </style>
</head>
<body>

<div id="app">
    <div id="info-bubble">Info</div>

    <div id="sc-login" class="screen" style="display:flex;">
        <div class="hero-title">CALON<br>MANTU<br>IDAMAN</div>
        <button class="btn-g" onclick="loginGoogle()">
            <span style="font-size:24px; color:#4285F4; font-weight:900;">G</span> MASUK DENGAN GOOGLE
        </button>
        <p id="log-err" style="display:none; color:red; margin-top:20px; background:#000; padding:5px;">Cek Domain Firebase!</p>
    </div>

    <div id="sc-lobby" class="screen">
        <div style="padding:20px; text-align:center;">
            <div class="edit-prof">
                <img id="my-av" class="edit-av" src="" onclick="document.getElementById('f-in').click()">
                <input type="file" id="f-in" hidden accept="image/*" onchange="upFoto(this)">
                <input type="text" id="my-name" value="Player" style="background:transparent; border:1px solid #555; color:white; padding:5px; text-align:center;">
                <button onclick="saveProf()" style="background:#27ae60; border:none; padding:8px 20px; color:white; border-radius:20px; margin-top:5px;">SIMPAN</button>
            </div>
            <div style="background:#000; padding:5px 15px; border-radius:15px; display:inline-block; border:1px solid gold;">üí∞ <span id="my-coin">0</span> üíé <span id="my-gem">0</span></div>
        </div>

        <div class="social-box">
            <div class="social-header">DAFTAR PEMAIN (KLIK + UNTUK INVITE)</div>
            <div id="player-list" class="player-list">
                </div>
        </div>

        <div class="menu-grid">
            <div class="mode-btn big-btn" onclick="findMatch()">
                <span style="font-size:30px;">üöÄ</span>
                <b>RANKED MATCH</b><small>Main Online</small>
            </div>
            <div class="mode-btn big-btn" onclick="startBot()">
                <span style="font-size:30px;">ü§ñ</span>
                <b>LATIHAN</b><small>Lawan Bot</small>
            </div>
            <div class="mode-btn shop-btn" onclick="showModal('m-shop')">
                <span style="font-size:24px;">üõí</span><b>TOKO</b>
            </div>
            <div class="mode-btn inv-btn" onclick="showModal('m-inv')">
                <span style="font-size:24px;">üéí</span><b>TAS</b>
            </div>
        </div>
    </div>

    <div id="sc-radar" class="screen" style="justify-content:center; align-items:center; text-align:center; background:rgba(0,0,0,0.95); z-index:100;">
        <h2 style="color:#2ecc71;">MENCARI PEMAIN...</h2>
        <div style="font-size:50px; animation:spin 2s infinite;">üì°</div>
        <div id="radar-list" style="margin:20px 0; color:#aaa;">Menunggu...</div>
        <button onclick="forceStart()" style="background:#e67e22; border:none; padding:15px 40px; border-radius:30px; color:white; font-weight:bold;">MULAI SEKARANG</button>
        <button onclick="quitMatch()" style="background:#c0392b; border:none; padding:10px 20px; border-radius:20px; color:white; margin-top:20px;">KEMBALI KE LOBBY</button>
    </div>

    <div id="sc-game" class="screen bg-board">
        <div id="game-header">
            <div id="c-p1" class="p-card"><img id="av-p1" class="pc-av"><div class="pc-info"><div id="nm-p1" class="pc-name">P1</div><div class="pc-stats">‚ù§Ô∏è<span id="ht-p1">0</span> üí∞<span id="mn-p1">0</span></div></div><div id="cb-p1" class="chat-b">Halo</div></div>
            <div id="c-p2" class="p-card"><img id="av-p2" class="pc-av"><div class="pc-info"><div id="nm-p2" class="pc-name">P2</div><div class="pc-stats">‚ù§Ô∏è<span id="ht-p2">0</span> üí∞<span id="mn-p2">0</span></div></div><div id="cb-p2" class="chat-b">Halo</div></div>
            <div id="c-p3" class="p-card"><img id="av-p3" class="pc-av"><div class="pc-info"><div id="nm-p3" class="pc-name">P3</div><div class="pc-stats">‚ù§Ô∏è<span id="ht-p3">0</span> üí∞<span id="mn-p3">0</span></div></div><div id="cb-p3" class="chat-b">Halo</div></div>
        </div>

        <button onclick="location.reload()" style="position:absolute; top:80px; right:10px; background:#c0392b; width:30px; height:30px; border-radius:50%; border:none; color:white; font-weight:bold; z-index:90;">üè†</button>

        <div id="p1-tok" class="pion"></div><div id="p2-tok" class="pion"></div><div id="p3-tok" class="pion"></div>
        <div id="dice-scn"><div class="cube"><div class="face f1">1</div><div class="face f2">2</div><div class="face f3">3</div><div class="face f4">4</div><div class="face f5">5</div><div class="face f6">6</div></div></div>
        
        <div id="turn-txt">Menunggu...</div>
        <div id="afk-warning" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:red; font-weight:bold; background:black; padding:5px; display:none; z-index:200;">AFK!</div>

        <button id="btn-kartu" class="btn-hide" onclick="alert('Belum punya kartu!')"></button>
        <button id="btn-kocok" class="btn-hide" onclick="rollD()"></button>
        <button id="btn-info" class="btn-hide" onclick="document.getElementById('m-info').style.display='flex'"></button>

        <button id="chat-btn" onclick="document.getElementById('chat-box').style.display='block'">üí¨</button>
        <div id="chat-box">
            <input id="chat-in" type="text" placeholder="Pesan..." style="width:70%;padding:5px;">
            <button onclick="sendChat()" style="width:25%;padding:5px;background:#2ecc71;color:white;border:none;">‚û§</button>
        </div>

        <div id="toast"></div>
    </div>

    <div id="m-invite-acc" class="modal">
        <div class="box">
            <img id="inv-pic" style="width:60px; height:60px; border-radius:50%; border:2px solid #fff;">
            <h3 id="inv-name" style="margin:10px 0;">Nama</h3>
            <p>Mengajak Duel!</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="acceptInvite()" style="background:#2ecc71; padding:10px 20px; border:none; color:white; border-radius:10px;">TERIMA</button>
                <button onclick="rejectInvite()" style="background:#e74c3c; padding:10px 20px; border:none; color:white; border-radius:10px;">TOLAK</button>
            </div>
        </div>
    </div>

    <div id="m-shop" class="modal" onclick="this.style.display='none'">
        <div class="box" onclick="event.stopPropagation()">
            <h3>TOKO SKIN</h3>
            <p>Fitur Segera Hadir!</p>
            <button onclick="document.getElementById('m-shop').style.display='none'" style="background:#c0392b; border:none; padding:10px; color:white;">TUTUP</button>
        </div>
    </div>
    
    <div id="m-inv" class="modal" onclick="this.style.display='none'">
        <div class="box" onclick="event.stopPropagation()">
            <h3>TAS SAYA</h3>
            <p>Kosong...</p>
            <button onclick="document.getElementById('m-inv').style.display='none'" style="background:#c0392b; border:none; padding:10px; color:white;">TUTUP</button>
        </div>
    </div>

    <div id="m-reward" class="modal">
        <div class="box">
            <h2 style="color:#00d2ff;">LOGIN BONUS! üíé</h2>
            <div style="font-size:60px; margin:20px;">üéÅ</div>
            <p id="rew-desc">Hadiah Harian</p>
            <button onclick="claimReward()" style="background:#2ecc71; padding:10px 30px; border:none; color:white; border-radius:20px; font-weight:bold;">AMBIL</button>
        </div>
    </div>

    <div id="m-info" class="modal" onclick="this.style.display='none'">
        <div class="box" onclick="event.stopPropagation()">
            <h3 style="color:#f1c40f;">INFORMASI LENGKAP</h3>
            <div style="text-align:left; font-size:12px; max-height:300px; overflow-y:auto;">
                <p><b>üèÜ ATURAN MENANG:</b><br>Kumpulkan <b>100 HATI</b> atau dapatkan Jackpot di kotak "Nekat Ngelamar".</p>
                <hr style="border:1px solid #555;">
                <p><b>üìç EFEK KOTAK:</b></p>
                <ul>
                    <li><b>Start:</b> +20 Uang, +10 Hati.</li>
                    <li><b>Martabak:</b> +15 Hati.</li>
                    <li><b>Puji Camer:</b> +20 Hati.</li>
                    <li><b>Pos Ronda:</b> -5 Uang (Denda).</li>
                    <li><b>THR Ponakan:</b> -10 Uang.</li>
                    <li><b>RSJ:</b> Hati Reset jadi 0.</li>
                    <li><b>Emas Palsu:</b> -15 Uang.</li>
                    <li><b>Social Experiment:</b> +25 Hati.</li>
                    <li><b>Mantan Datang:</b> -15 Hati.</li>
                    <li><b>Nekat Ngelamar:</b> +50 Hati.</li>
                </ul>
                <hr style="border:1px solid #555;">
                <p><b>üÉè DAFTAR KARTU:</b></p>
                <ul>
                    <li><b>Kesempatan:</b> Dapat Uang Kaget (+30).</li>
                    <li><b>Ekstrem:</b> Kena Begal (-20 Uang).</li>
                    <li><b>Prank:</b> Hati berkurang (-10).</li>
                    <li><b>Spesial:</b> Bebas Penjara/RSJ.</li>
                </ul>
            </div>
            <button onclick="document.getElementById('m-info').style.display='none'" style="background:#c0392b; width:100%; padding:10px; border:none; color:white; margin-top:10px;">TUTUP</button>
        </div>
    </div>

    <div id="m-card" class="modal">
        <div class="box">
            <h3 id="c-title" style="color:#f1c40f;">KARTU</h3>
            <div style="font-size:60px; margin:20px;">üÉè</div>
            <p id="c-desc">...</p>
        </div>
    </div>
    
    <div id="m-win" class="modal" style="background:rgba(0,0,0,0.95);">
        <div class="box" style="border-color:#2ecc71;">
            <h1 style="color:#2ecc71;">MENANG! üèÜ</h1>
            <img id="w-av" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid gold;">
            <h2 id="w-nm">Nama</h2>
            <p>Mendapatkan 100 Hati!</p>
            <button onclick="location.reload()" style="background:#e67e22; padding:10px 30px; border:none; color:white; border-radius:20px;">MAIN LAGI</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, onDisconnect, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

const cfg = {
    apiKey: "AIzaSyCF0Zn-DSK6z3x_4ETIcAwweHk5tR_bpn0",
    authDomain: "mantu-1f6f4.firebaseapp.com",
    databaseURL: "https://mantu-1f6f4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mantu-1f6f4",
    appId: "1:674923969086:web:ffb34307261bbfae74af6f"
};

const app=initializeApp(cfg); const db=getDatabase(app); const auth=getAuth(app);
let user, stats, rId, role, game, chatUnsub, afkTimer, afkCount=0;
const tiles=[{id:0,x:11,y:68.3},{id:1,x:30.5,y:68.3},{id:2,x:50,y:68.3},{id:3,x:69.5,y:68.3},{id:4,x:89,y:68.3},{id:5,x:89,y:57.1},{id:6,x:89,y:45.8},{id:7,x:89,y:34.5},{id:8,x:89,y:23.2},{id:9,x:69.5,y:23.2},{id:10,x:50,y:23.2},{id:11,x:30.5,y:23.2},{id:12,x:11,y:23.2},{id:13,x:11,y:34.5},{id:14,x:11,y:45.8},{id:15,x:11,y:57.1}];
const botNames=["Sultan","Dinda","KangBakso","ProPlayer","RatuGosip"];

onAuthStateChanged(auth, u=>{ if(u){ user=u; loadProf(); } else { show('sc-login'); } });
window.loginGoogle=()=>{ signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>{alert("Login Gagal: Cek Domain Firebase!");}); }

async function loadProf(){
    const s=await get(ref(db,'users/'+user.uid));
    const def={name:user.displayName, photo:user.photoURL, koin:1000, gem:0, lastLogin:0, streak:0};
    stats=s.exists()?s.val():def; 
    if(!stats.gem) stats.gem=0;
    if(!s.exists()) set(ref(db,'users/'+user.uid), stats);
    
    // Update Online Status
    const statusRef = ref(db, 'status/' + user.uid);
    set(statusRef, { name: stats.name, photo: stats.photo, online: true });
    onDisconnect(statusRef).remove();

    document.getElementById('my-av').src=stats.photo;
    document.getElementById('my-name').value=stats.name;
    document.getElementById('my-coin').innerText=stats.koin;
    document.getElementById('my-gem').innerText=stats.gem;
    
    checkDailyReward();
    listenLobbyPlayers();
    listenInvites();
    show('sc-lobby');
}

// DAILY REWARD
function checkDailyReward(){
    const today = new Date().toDateString();
    if(stats.lastLogin !== today){
        const isConsecutive = (new Date(new Date().setDate(new Date().getDate()-1)).toDateString() === stats.lastLogin);
        stats.streak = isConsecutive ? stats.streak + 1 : 1;
        window.pendingReward = stats.streak;
        document.getElementById('rew-desc').innerText = `Login Hari ke-${stats.streak}\nHadiah: +${stats.streak} Berlian`;
        document.getElementById('m-reward').style.display = 'flex';
        
        stats.lastLogin = today;
        update(ref(db,'users/'+user.uid), {lastLogin:today, streak:stats.streak});
    }
}
window.claimReward = () => {
    stats.gem += window.pendingReward;
    update(ref(db,'users/'+user.uid), {gem:stats.gem});
    document.getElementById('my-gem').innerText = stats.gem;
    document.getElementById('m-reward').style.display='none';
}

// PLAYER LIST LOBBY
function listenLobbyPlayers() {
    onValue(ref(db, 'status'), (snap) => {
        const list = document.getElementById('player-list');
        list.innerHTML = "";
        snap.forEach((child) => {
            if(child.key !== user.uid) {
                const p = child.val();
                list.innerHTML += `
                <div class="p-item on">
                    <img src="${p.photo}">
                    <div style="flex:1">
                        <div>${p.name}</div>
                        <div style="font-size:10px; color:#2ecc71;"><span class="stat-dot"></span>Online</div>
                    </div>
                    <button class="inv-btn" onclick="sendInv('${child.key}', '${p.name}')">+</button>
                </div>`;
            }
        });
    });
}

// INVITE SYSTEM
window.sendInv = (uid, nm) => {
    const rid = "R"+Date.now();
    set(ref(db,'invites/'+uid), {from:stats.name, pic:stats.photo, rid:rid});
    tost("Mengundang "+nm+"...");
    createRoom(rid);
}

function listenInvites() {
    onValue(ref(db, 'invites/' + user.uid), (snap) => {
        if(snap.exists()) {
            const val = snap.val();
            document.getElementById('inv-name').innerText = val.from;
            document.getElementById('inv-pic').src = val.pic;
            window.pendingInvite = val;
            document.getElementById('m-invite-acc').style.display = 'flex';
        }
    });
}

window.acceptInvite = () => {
    remove(ref(db, 'invites/' + user.uid));
    document.getElementById('m-invite-acc').style.display = 'none';
    joinRoom(window.pendingInvite.rid);
}

window.rejectInvite = () => {
    remove(ref(db, 'invites/' + user.uid));
    document.getElementById('m-invite-acc').style.display = 'none';
}

// MATCHMAKING
window.quitMatch = () => show('sc-lobby');

window.findMatch=async()=>{
    show('sc-radar'); document.getElementById('radar-list').innerText=`Mencari...`;
    const s=await get(ref(db,'rooms')); let found=null;
    if(s.exists()){ s.forEach(c=>{ const r=c.val(); if(r.st=='waiting' && (!r.p2.j||!r.p3.j)) found=c.key; }); }
    if(found) joinRoom(found); else createRoom("R"+Date.now());
}

async function createRoom(id){
    rId=id; role='p1';
    const pD={pos:0, u:20, h:0, j:true, nm:stats.name, pic:stats.photo, bot:false};
    await set(ref(db,'rooms/'+rId), {st:'waiting', turn:'p1', p1:pD, p2:{j:false}, p3:{j:false}, lastAct:Date.now()});
    listenRoom(rId);
}

async function joinRoom(id){
    rId=id;
    const s=await get(ref(db,'rooms/'+rId)); const d=s.val();
    if(!d.p2.j) role='p2'; else if(!d.p3.j) role='p3'; else return alert("Penuh!");
    const pD={pos:0, u:20, h:0, j:true, nm:stats.name, pic:stats.photo, bot:false};
    await update(ref(db,`rooms/${rId}/${role}`), pD);
    listenRoom(rId);
}

function listenRoom(id){
    onValue(ref(db,'rooms/'+id), s=>{
        const d=s.val(); if(!d) return;
        game=d;
        if(d.st=='waiting'){
            let h=""; ['p1','p2','p3'].forEach(r=>{ if(d[r] && d[r].j) h+=`<div>${d[r].nm}</div>`; });
            document.getElementById('radar-list').innerHTML=h;
        } else {
            show('sc-game'); updUI(); handleTurnLogic();
        }
    });
}

window.forceStart=()=>{
    if(role!='p1') return;
    const u={st:'playing'};
    if(!game.p2.j) u['p2']=mkBot();
    if(!game.p3.j) u['p3']=mkBot();
    update(ref(db,'rooms/'+rId), u);
}
function mkBot(){ const n=botNames[Math.floor(Math.random()*botNames.length)]; return {pos:0, u:20, h:0, j:true, nm:n, pic:`https://api.dicebear.com/7.x/bottts/svg?seed=${n}`, bot:true}; }

// GAMEPLAY
window.startBot=()=>{
    rId='local'; role='p1';
    game={st:'playing', turn:'p1', p1:{pos:0,u:20,h:0,j:true,nm:stats.name,pic:stats.photo}, p2:mkBot(), p3:mkBot()};
    show('sc-game'); updUI(); handleTurnLogic();
}

async function moveVisual(r, start, steps){
    const el=document.getElementById(r+'-tok');
    let curr = start;
    let ox=0, oy=0; 
    if(r=='p2' && game.p1.pos==game.p2.pos) {ox=3; oy=-3;} 
    if(r=='p3') {ox=-3; oy=3;}

    for(let i=0; i<steps; i++){
        curr++; if(curr>=16){curr=0; popInfo("Start: +20 Uang +10 Hati");}
        el.style.transition='none'; el.classList.add('jumping');
        const t=tiles[curr]; 
        el.style.left=(t.x+ox)+'%'; el.style.top=(t.y+oy)+'%';
        await new Promise(res=>setTimeout(res, 500));
        el.classList.remove('jumping');
        void el.offsetWidth;
    }
    return curr;
}

window.rollD=async()=>{
    if(game.turn!=role) return;
    stopAFK();
    
    const d=Math.floor(Math.random()*6)+1; visDice(d);
    await new Promise(r=>setTimeout(r, 1500));
    
    let p=game[role]; 
    const np=await moveVisual(role, p.pos, d);
    p.pos=np; if(np<p.pos){p.u+=20; p.h+=10;} 
    checkTile(p);
    
    if(p.h>=100){ showWin(p); return; }
    
    setTimeout(()=>{
        const nt=nextTurn(game.turn);
        if(rId=='local'){ game.turn=nt; updUI(); handleTurnLogic(); }
        else update(ref(db,`rooms/${rId}`), {turn:nt, [role]:p, lastAct:Date.now()});
    }, 2000);
}

function handleTurnLogic(){
    clearTimeout(afkTimer);
    document.getElementById('afk-warning').style.display='none';
    const currP = game[game.turn];
    
    if(game.turn === role){
        afkTimer = setTimeout(()=>{
            document.getElementById('afk-warning').style.display='block';
            tost("AFK! Mengocok otomatis...");
            afkCount++; if(afkCount>=3) { alert("Keluar karena AFK!"); location.reload(); }
            rollD();
        }, 30000);
    }
    else if(currP.bot && (role=='p1' || rId=='local')){
        setTimeout(()=>runBot(game.turn), 1500);
    }
}

function stopAFK(){ clearTimeout(afkTimer); afkCount=0; }

async function runBot(br){
    const d=Math.floor(Math.random()*6)+1; visDice(d);
    await new Promise(r=>setTimeout(r, 1500));
    
    let p=game[br]; const np=await moveVisual(br, p.pos, d);
    p.pos=np; if(np<p.pos){p.u+=20; p.h+=10;} checkTile(p, true);
    
    if(p.h>=100){ showWin(p); return; }
    
    setTimeout(()=>{
        const nt=nextTurn(br);
        if(rId=='local'){ game.turn=nt; updUI(); handleTurnLogic(); }
        else update(ref(db,`rooms/${rId}`), {turn:nt, [br]:p});
    }, 1000);
}

function checkTile(p, bot=false){
    const i=p.pos; let m="";
    if(i==1){p.u-=3; p.h+=15; m="Martabak (+15 Hati)";}
    else if(i==2||i==7){m="Kartu!"; if(!bot) showCard("KESEMPATAN", "Dapat +30 Uang!", p);}
    else if(i==3){p.h+=20; m="Puji Camer (+20 Hati)";}
    else if(i==4){p.u-=5; m="Pos Ronda (-5 Uang)";}
    else if(i==5){p.pos=0; m="Supir Dadakan! Balik Start";}
    else if(i==6){p.u-=10; m="THR (-10 Uang)";}
    else if(i==8){p.h=0; m="RSJ (Hati Reset 0)";}
    else if(i==9){p.u-=5; m="Genteng Bocor";}
    else if(i==10){p.u-=15; m="Emas Palsu (-15 Uang)";}
    else if(i==11){p.h+=25; m="Viral (+25 Hati)";}
    else if(i==12||i==13){m="Extrem!"; if(!bot) showCard("EXTREME", "Kena Begal! -20 Uang", p);}
    else if(i==14){p.h-=15; m="Mantan (-15 Hati)";}
    else if(i==15){p.h+=50; m="Nekat Ngelamar (+50 Hati)";}
    if(m) popInfo((bot?p.nm+": ":"")+m);
}

function showCard(t, d, p){
    if(t=="KESEMPATAN") p.u+=30; if(t=="EXTREME") p.u-=20;
    document.getElementById('c-title').innerText=t; document.getElementById('c-desc').innerText=d;
    document.getElementById('m-card').style.display='flex';
    setTimeout(() => { document.getElementById('m-card').style.display='none'; }, 3000);
}

function popInfo(msg){
    const b = document.getElementById('info-bubble');
    b.innerText = msg; b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), 2000);
}

function updUI(){
    ['p1','p2','p3'].forEach(r=>{
        const d=game[r]; const av=document.getElementById('av-'+r); const tok=document.getElementById(r+'-tok');
        document.getElementById('nm-'+r).innerText=d&&d.j?d.nm:"Kosong";
        av.src=d&&d.j?d.pic:""; 
        document.getElementById('ht-'+r).innerText=d&&d.j?d.h:"-";
        document.getElementById('mn-'+r).innerText=d&&d.j?d.u:"-";
        
        if(d&&d.j){
            tok.style.display='block';
            tok.style.backgroundImage = `url('${d.pic}')`;
            if(!tok.classList.contains('jumping')){
                const c=tiles[d.pos];
                let ox=0, oy=0;
                if(r=='p2' && game.p1.pos==d.pos) {ox=3; oy=-3;}
                if(r=='p3' && game.p1.pos==d.pos) {ox=-3; oy=3;}
                tok.style.left=(c.x+ox)+'%'; tok.style.top=(c.y+oy)+'%';
            }
        } else tok.style.display='none';
        
        if(game.turn==r && d.j) av.classList.add('active-glow'); else av.classList.remove('active-glow');
    });
    const t=document.getElementById('turn-txt');
    if(game.turn==role){t.innerText="GILIRANMU!"; t.style.background="#2ecc71";}
    else{t.innerText=`Giliran ${game[game.turn].nm}...`; t.style.background="#e74c3c";}
}

function nextTurn(c){ return c=='p1'?(game.p2.j?'p2':(game.p3.j?'p3':'p1')):(c=='p2'?(game.p3.j?'p3':'p1'):'p1'); }

// CHAT
window.togChat=()=>{const b=document.getElementById('chat-box'); b.style.display=b.style.display=='block'?'none':'block';}
window.sendChat=()=>{
    const t=document.getElementById('chat-in').value; if(!t)return;
    if(rId=='local'){showBub('p1',t); setTimeout(()=>showBub('p2','Wkwk'),1000);}
    else push(ref(db,`rooms/${rId}/chat`),{r:role,t:t});
    document.getElementById('chat-in').value=''; document.getElementById('chat-box').style.display='none';
}
function initChat(id){
    if(chatUnsub) chatUnsub(); if(id=='local')return;
    chatUnsub=onChildAdded(ref(db,`rooms/${id}/chat`), s=>{const m=s.val(); showBub(m.r, m.t);});
}
function showBub(r,t){const b=document.getElementById('cb-'+r);if(b){b.innerText=t;b.style.display='block';setTimeout(()=>b.style.display='none',3000);}}

// UTIL
window.showModal=(id)=>document.getElementById(id).style.display='flex';
window.showCardInfo=()=>{tost("Tunggu dapat kartu!");}
window.showRule=()=>{document.getElementById('m-info').style.display='flex';}
function showWin(p){document.getElementById('w-nm').innerText=p.nm; document.getElementById('w-av').src=p.pic; document.getElementById('m-win').style.display='flex';}
function show(id){['sc-login','sc-lobby','sc-radar','sc-game'].forEach(s=>document.getElementById(s).style.display=s==id?'flex':'none');}
function visDice(v){const c=document.querySelector('.cube');document.getElementById('dice-scn').style.display='block'; c.style.transform=`rotateX(${Math.random()*720}deg) rotateY(${Math.random()*720}deg)`; setTimeout(()=>{let x=0,y=0; if(v==2)y=-90;if(v==3)y=-180;if(v==4)y=90;if(v==5)x=-90;if(v==6)x=90; c.style.transform=`rotateX(${x+720}deg) rotateY(${y+720}deg)`;},500); setTimeout(()=>document.getElementById('dice-scn').style.display='none',2000);}
function tost(m){const d=document.createElement('div');d.className='t-msg';d.innerText=m;document.getElementById('toast').appendChild(d);setTimeout(()=>d.remove(),3000);}
window.saveProf=()=>{ const n=document.getElementById('my-name').value; const p=document.getElementById('my-av').src; update(ref(db,'users/'+user.uid),{name:n, photo:p}).then(()=>{ stats.name=n; stats.photo=p; tost("Disimpan!"); }); }
window.upFoto=(i)=>{ if(i.files[0]){ const r=new FileReader(); r.onload=e=>document.getElementById('my-av').src=e.target.result; r.readAsDataURL(i.files[0]); } }
</script>
</body>
</html>
