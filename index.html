<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calon Mantu Online (Asia)</title>
    <style>
        /* --- RESET & LAYOUT --- */
        body { margin: 0; padding: 0; background-color: #222; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100dvh; user-select: none; }
        
        #game-container { 
            position: relative; height: 100%; aspect-ratio: 9/16; 
            background-image: url('https://res.cloudinary.com/dsutaioqw/image/upload/v1770514507/board_gukevw.png'); 
            background-size: contain; background-repeat: no-repeat; background-position: center; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8); 
            perspective: 1000px; 
        }

        /* --- UI ATAS (AVATAR & STATS) --- */
        .avatar-box { 
            position: absolute; top: 7.3%; width: 13.5%; aspect-ratio: 1/1; 
            border-radius: 50%; transform: translate(-50%, -50%); 
            background-color: #ddd; background-size: cover; border: 2px solid white; 
            z-index: 5; transition: transform 0.3s; 
        }
        .active-turn { transform: translate(-50%, -50%) scale(1.2); border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        
        #p1-avatar { left: 16.5%; background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix&backgroundColor=ffdfbf'); } 
        #p2-avatar { left: 83.5%; background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Grandma&backgroundColor=b6e3f4'); } 

        /* POSISI STATS (DITURUNKAN 1% SESUAI REQUEST) */
        .stat-box { 
            position: absolute; 
            top: 8.3%; /* SEBELUMNYA 7.3% -> TURUN JADI 8.3% */
            transform: translate(-50%, -50%); 
            width: 16%; text-align: center; font-size: 2.1vh; font-weight: 800; color: #5d4037; 
            z-index: 6; letter-spacing: -0.5px; 
        }
        #ui-hati { left: 36.0%; } 
        #ui-uang { left: 66.0%; } 

        /* --- DADU 3D --- */
        #dice-scene { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; z-index: 50; display: none; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .cube__face { position: absolute; width: 80px; height: 80px; background: white; border: 2px solid #ccc; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 40px; font-weight: bold; color: #333; box-shadow: inset 0 0 15px rgba(0,0,0,0.1); }
        .cube__face--1 { transform: rotateY(  0deg) translateZ(40px); }
        .cube__face--2 { transform: rotateY( 90deg) translateZ(40px); }
        .cube__face--3 { transform: rotateY(180deg) translateZ(40px); }
        .cube__face--4 { transform: rotateY(-90deg) translateZ(40px); }
        .cube__face--5 { transform: rotateX( 90deg) translateZ(40px); }
        .cube__face--6 { transform: rotateX(-90deg) translateZ(40px); }
        .dot { width: 15px; height: 15px; background: #e74c3c; border-radius: 50%; display: inline-block; }

        /* --- BIDAK --- */
        .pion { position: absolute; width: 7%; aspect-ratio: 1/1; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 5px 10px rgba(0,0,0,0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 10; transform: translate(-50%, -50%); display: none; }
        #p1-token { background: #3498db; }
        #p2-token { background: #e74c3c; transform: translate(-30%, -30%) scale(0.8); }

        /* --- STATUS BAR --- */
        #status-bar-container { position: absolute; bottom: 21%; left: 50%; transform: translateX(-50%); width: 100%; text-align: center; pointer-events: none; z-index: 30; }
        #turn-bar { display: inline-block; background: #3498db; color: white; padding: 8px 25px; border-radius: 20px; font-size: 2vh; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: 0.3s; }

        /* CONTROLS */
        .btn-area { position: absolute; z-index: 20; cursor: pointer; border-radius: 15px; }
        #btn-kocok { bottom: 3.5%; left: 50%; transform: translateX(-50%); width: 42%; height: 10%; border-radius: 40px; }
        #btn-kocok:active { background: rgba(255,255,255,0.2); }

        /* LOBBY */
        #lobby-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; backdrop-filter: blur(10px); }
        .lobby-box { background: white; padding: 25px; border-radius: 20px; color: #333; text-align: center; width: 75%; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { padding: 12px; font-size: 18px; width: 85%; margin-bottom: 15px; text-align: center; border: 2px solid #ddd; border-radius: 10px; font-weight: bold; letter-spacing: 1px;}
        .role-btn { display: block; width: 100%; padding: 15px; margin: 8px 0; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: transform 0.1s; }
        .role-btn:active { transform: scale(0.95); }
        .btn-p1 { background: #3498db; } .btn-p2 { background: #e74c3c; }

        /* TOAST */
        #toast-container { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 5px; align-items: center; z-index: 99; width: 80%; pointer-events: none; }
        .toast-msg { background: rgba(0,0,0,0.85); color: white; padding: 8px 16px; border-radius: 20px; font-size: 1.6vh; animation: fadeInOut 2.5s forwards; border: 1px solid rgba(255,255,255,0.2); }
        @keyframes fadeInOut { 0% {opacity:0; transform:translateY(-10px);} 10% {opacity:1; transform:translateY(0);} 90% {opacity:1;} 100% {opacity:0; display:none;} }
    </style>
</head>
<body>

<div id="game-container">
    
    <div id="lobby-screen">
        <div class="lobby-box">
            <h2 style="margin-top:0; color:#2c3e50;">PEJUANG RESTU</h2>
            <p style="margin-bottom:5px;">Masukkan Kode Room:</p>
            <input type="text" id="room-input" placeholder="ROOM1" value="ROOM1">
            <p style="font-size:12px; color:#7f8c8d; margin-top:-10px;">(Samakan kode room di kedua HP)</p>
            
            <button class="role-btn btn-p1" onclick="joinGame('p1')">ðŸ”µ SAYA PLAYER 1 (Biru)</button>
            <button class="role-btn btn-p2" onclick="joinGame('p2')">ðŸ”´ SAYA PLAYER 2 (Merah)</button>
        </div>
    </div>

    <div id="p1-avatar" class="avatar-box"></div>
    <div id="p2-avatar" class="avatar-box"></div>
    
    <div id="ui-hati" class="stat-box">0</div>
    <div id="ui-uang" class="stat-box">20</div>

    <div id="p1-token" class="pion"></div>
    <div id="p2-token" class="pion"></div>

    <div id="dice-scene">
        <div class="cube">
            <div class="cube__face cube__face--1"><div class="dot"></div></div>
            <div class="cube__face cube__face--2">2</div>
            <div class="cube__face cube__face--3">3</div>
            <div class="cube__face cube__face--4">4</div>
            <div class="cube__face cube__face--5">5</div>
            <div class="cube__face cube__face--6">6</div>
        </div>
    </div>

    <div id="status-bar-container">
        <div id="turn-bar">Menunggu Lawan...</div>
    </div>
    
    <div id="toast-container"></div>
    <div id="btn-kocok" class="btn-area" onclick="handleRollDice()"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // --- CONFIG FIREBASE (ASIA SINGAPORE) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCF0Zn-DSK6z3x_4ETIcAwweHk5tR_bpn0",
        authDomain: "mantu-1f6f4.firebaseapp.com",
        databaseURL: "https://mantu-1f6f4-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mantu-1f6f4",
        storageBucket: "mantu-1f6f4.firebasestorage.app",
        messagingSenderId: "674923969086",
        appId: "1:674923969086:web:ffb34307261bbfae74af6f",
        measurementId: "G-W2N2YVDTST"
    };

    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        console.log("Firebase Init OK");
    } catch (e) {
        alert("Gagal konek Firebase: " + e.message);
    }

    // --- GAME VARIABLES ---
    let myRole = ""; 
    let roomId = "";
    
    let gameState = {
        turn: 'p1',
        p1: { pos: 0, uang: 20, hati: 0, joined: false },
        p2: { pos: 0, uang: 20, hati: 0, joined: false },
        lastDice: 0
    };

    const tiles = [
        { id: 0, x: 11.0, y: 68.3 }, { id: 1, x: 30.5, y: 68.3 }, { id: 2, x: 50.0, y: 68.3 }, { id: 3, x: 69.5, y: 68.3 },
        { id: 4, x: 89.0, y: 68.3 }, { id: 5, x: 89.0, y: 57.1 }, { id: 6, x: 89.0, y: 45.8 }, { id: 7, x: 89.0, y: 34.5 },
        { id: 8, x: 89.0, y: 23.2 }, { id: 9, x: 69.5, y: 23.2 }, { id: 10, x: 50.0, y: 23.2 }, { id: 11, x: 30.5, y: 23.2 },
        { id: 12, x: 11.0, y: 23.2 }, { id: 13, x: 11.0, y: 34.5 }, { id: 14, x: 11.0, y: 45.8 }, { id: 15, x: 11.0, y: 57.1 }
    ];

    // --- JOIN LOGIC ---
    window.joinGame = (role) => {
        const input = document.getElementById('room-input').value.toUpperCase().replace(/\s/g, '');
        if(!input) return alert("Isi Kode Room dulu!");
        
        roomId = input;
        myRole = role;
        
        document.getElementById('lobby-screen').style.display = 'none';

        // 1. Cek Koneksi ke Room
        const roomRef = ref(db, 'rooms/' + roomId);
        pushToast(`Menghubungkan ke ${roomId}...`);

        // 2. Tandai saya join (Update)
        // Kita gunakan .catch untuk cek error
        update(ref(db, `rooms/${roomId}/${myRole}`), { joined: true })
            .then(() => pushToast("ðŸ”¥ Terhubung ke Firebase!"))
            .catch((err) => {
                alert("Gagal Update Data: " + err.message);
                console.error(err);
            });

        // 3. Listener Data Realtime
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                // Data ada, sinkronkan
                gameState = data;
                updateScreen();
            } else {
                // Room kosong, inisialisasi awal
                // Hanya dilakukan oleh orang pertama yg masuk
                if(myRole === 'p1') {
                    let initData = { ...gameState };
                    initData.p1.joined = true;
                    set(roomRef, initData);
                }
            }
        });
    };

    // --- GAMEPLAY LOGIC ---
    window.handleRollDice = () => {
        if(!gameState.p1.joined || !gameState.p2.joined) {
            pushToast("âŒ Lawan belum masuk!"); return;
        }
        if(gameState.turn !== myRole) {
            pushToast("â³ Sabar, giliran lawan!"); return;
        }

        const diceVal = Math.floor(Math.random() * 6) + 1;
        
        // 1. Animasi Dadu
        rollDiceVisual(diceVal);

        // 2. Logic & Update
        setTimeout(() => {
            let currentPlayer = gameState[myRole];
            let steps = diceVal;
            let currentPos = currentPlayer.pos;
            
            // Loop langkah
            for(let i=0; i<steps; i++){
                currentPos++;
                if(currentPos >= 16) {
                    currentPos = 0;
                    currentPlayer.uang += 10;
                }
            }
            currentPlayer.pos = currentPos;
            
            // Efek Simple
            if(currentPos === 1) { currentPlayer.uang -= 3; currentPlayer.hati += 2; }

            const nextTurn = (gameState.turn === 'p1') ? 'p2' : 'p1';
            
            // Update Server
            const updates = {};
            updates[`rooms/${roomId}/${myRole}`] = currentPlayer;
            updates[`rooms/${roomId}/turn`] = nextTurn;
            update(ref(db), updates);

        }, 1500);
    };

    // --- VISUAL ---
    function updateScreen() {
        // Tampilkan Bidak jika Joined
        if(gameState.p1.joined) {
            document.getElementById('p1-token').style.display = 'block';
            movePion('p1', gameState.p1.pos);
        }
        if(gameState.p2.joined) {
            document.getElementById('p2-token').style.display = 'block';
            movePion('p2', gameState.p2.pos);
        }

        // Update Stats Saya
        const myData = gameState[myRole];
        if(myData) {
            document.getElementById('ui-uang').innerText = myData.uang;
            document.getElementById('ui-hati').innerText = myData.hati;
        }

        // Status Bar
        const bar = document.getElementById('turn-bar');
        
        if(!gameState.p1.joined || !gameState.p2.joined) {
            bar.innerText = "Menunggu Lawan Join...";
            bar.style.background = "#95a5a6";
            return;
        }

        if(gameState.turn === myRole) {
            bar.innerText = "Giliranku! (Klik Dadu)";
            bar.style.background = (myRole === 'p1') ? '#3498db' : '#e74c3c';
            document.getElementById('btn-kocok').style.pointerEvents = 'auto';
        } else {
            bar.innerText = `Giliran ${myRole === 'p1' ? 'P2' : 'P1'}...`;
            bar.style.background = "#7f8c8d";
            document.getElementById('btn-kocok').style.pointerEvents = 'none';
        }

        document.getElementById('p1-avatar').classList.toggle('active-turn', gameState.turn === 'p1');
        document.getElementById('p2-avatar').classList.toggle('active-turn', gameState.turn === 'p2');
    }

    function movePion(role, pos) {
        const coord = tiles[pos];
        const el = document.getElementById(role === 'p1' ? 'p1-token' : 'p2-token');
        el.style.left = coord.x + "%";
        el.style.top = coord.y + "%";
    }

    function rollDiceVisual(finalVal) {
        const scene = document.getElementById('dice-scene');
        const cube = document.querySelector('.cube');
        scene.style.display = 'block';

        const xRand = Math.floor(Math.random() * 360 * 5); 
        const yRand = Math.floor(Math.random() * 360 * 5);
        cube.style.transition = 'transform 0.5s ease-in';
        cube.style.transform = `rotateX(${xRand}deg) rotateY(${yRand}deg)`;

        setTimeout(() => {
            cube.style.transition = 'transform 0.8s cubic-bezier(0.25, 1, 0.5, 1)';
            let xFinal = 0, yFinal = 0;
            switch(finalVal) {
                case 1: xFinal = 0; yFinal = 0; break;
                case 2: xFinal = 0; yFinal = -90; break;
                case 3: xFinal = 0; yFinal = -180; break;
                case 4: xFinal = 0; yFinal = 90; break;
                case 5: xFinal = -90; yFinal = 0; break;
                case 6: xFinal = 90; yFinal = 0; break;
            }
            cube.style.transform = `rotateX(${xFinal + 720}deg) rotateY(${yFinal + 720}deg)`;
        }, 500);

        setTimeout(() => { scene.style.display = 'none'; }, 2500);
    }

    function pushToast(msg) {
        let div = document.createElement('div');
        div.className = "toast-msg";
        div.innerText = msg;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(() => div.remove(), 2600);
    }
</script>
</body>
</html>
