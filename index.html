<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calon Mantu: Social v3.1</title>
    <style>
        /* --- CSS LENGKAP AGAR TIDAK BLANK --- */
        body { margin: 0; padding: 0; background-color: #0f1c2e; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100dvh; color: white; }
        #app-container { position: relative; width: 100%; max-width: 500px; height: 100%; background: #131d2a; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* LOGIN & LOBBY */
        #screen-login, #screen-lobby { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; z-index: 1000; }
        #screen-login { background: rgba(15, 28, 46, 0.95); justify-content: center; align-items: center; }
        #screen-lobby { background: linear-gradient(135deg, #091320 0%, #1c2a3f 100%); display: none; }
        
        .lobby-header { padding: 20px; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .profile-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #f1c40f; }
        .coin-display { margin-left: auto; background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px; border: 1px solid #f39c12; color: #f1c40f; font-weight: bold; font-size: 14px; }

        .tab-btn { background: #3498db; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; flex: 1; }
        .mode-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; display: flex; align-items: center; cursor: pointer; margin: 20px; }

        /* LIST ONLINE & INVITE */
        .player-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .btn-plus { background: #2ecc71; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; font-weight: bold; cursor: pointer; }

        /* GAME ELEMENTS */
        .avatar-game { position: absolute; top: 7.7%; width: 12%; aspect-ratio: 1/1; border-radius: 50%; transform: translate(-50%, -50%); background-size: cover; border: 2px solid white; z-index: 5; }
        #p1-av { left: 16.5%; } #p2-av { left: 83.5%; }
        .stat-box { position: absolute; top: 8.5%; transform: translate(-50%, -50%); width: 14%; text-align: center; font-size: 1.6vh; font-weight: 900; color: #5d4037; z-index: 6; }
        #ui-hati { left: 36.5%; } #ui-uang { left: 66.5%; }

        /* MODAL */
        #invite-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .invite-box { background: #1c2a3f; padding: 30px; border-radius: 20px; width: 75%; text-align: center; border: 2px solid #f1c40f; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="screen-login">
        <h1 style="color:#f1c40f;">CALON MANTU</h1>
        <button onclick="loginGoogle()" style="padding:15px 30px; border-radius:30px; border:none; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:10px;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20"> Masuk dengan Google
        </button>
    </div>

    <div id="screen-lobby">
        <div class="lobby-header">
            <img id="user-photo" src="" class="profile-img">
            <div><h4 id="user-name" style="margin:0;">User</h4><small style="color:#2ecc71;">Online</small></div>
            <div class="coin-display">üí∞ <span id="user-coin">0</span></div>
        </div>

        <div style="display:flex; padding:15px 20px; gap:10px;">
            <button class="tab-btn" id="btn-play" onclick="switchTab('play')">PLAY</button>
            <button class="tab-btn" id="btn-online" onclick="switchTab('online')" style="background:rgba(255,255,255,0.1);">ONLINE (+)</button>
        </div>

        <div id="tab-play">
            <div class="mode-card" onclick="startBotMode()" style="border-left:5px solid #3498db;">
                <div style="font-size:30px; margin-right:15px;">ü§ñ</div>
                <div><h4 style="margin:0;">LATIHAN BOT</h4><small>Main Offline</small></div>
            </div>
        </div>

        <div id="tab-online" style="display:none; padding:0 20px;">
            <div id="online-list"></div>
        </div>
    </div>

    <div id="invite-modal">
        <div class="invite-box">
            <img id="inviter-photo" src="" style="width:70px; height:70px; border-radius:50%; border:2px solid white;">
            <h3 id="inviter-name" style="color:white; margin:15px 0;">Nama</h3>
            <p>Mengajak Duel Restu!</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="acceptInvite()" style="flex:1; padding:12px; background:#2ecc71; border:none; border-radius:10px; color:white; font-weight:bold; cursor:pointer;">TERIMA</button>
                <button onclick="rejectInvite()" style="flex:1; padding:12px; background:#e74c3c; border:none; border-radius:10px; color:white; font-weight:bold; cursor:pointer;">TOLAK</button>
            </div>
        </div>
    </div>

    <div id="screen-game" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:url('https://res.cloudinary.com/dsutaioqw/image/upload/v1770514507/board_gukevw.png') center/contain no-repeat; background-color:#222;">
        <button onclick="location.reload()" style="position:absolute; top:20px; left:20px; z-index:100; padding:10px; border-radius:50%; border:none; cursor:pointer;">üè†</button>
        <div id="p1-av" class="avatar-game"></div><div id="p2-av" class="avatar-game"></div>
        <div id="ui-hati" class="stat-box">0</div><div id="ui-uang" class="stat-box">20</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCF0Zn-DSK6z3x_4ETIcAwweHk5tR_bpn0",
        authDomain: "mantu-1f6f4.firebaseapp.com",
        databaseURL: "https://mantu-1f6f4-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mantu-1f6f4",
        storageBucket: "mantu-1f6f4.firebasestorage.app",
        messagingSenderId: "674923969086",
        appId: "1:674923969086:web:ffb34307261bbfae74af6f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null, userStats = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            setupPresence(user);
            loadProfile(user);
            listenInvites();
        } else {
            document.getElementById('screen-login').style.display = 'flex';
            document.getElementById('screen-lobby').style.display = 'none';
        }
    });

    window.loginGoogle = () => signInWithPopup(auth, provider);

    async function loadProfile(user) {
        const snap = await get(ref(db, 'users/' + user.uid));
        userStats = snap.exists() ? snap.val() : { name: user.displayName, photo: user.photoURL, koin: 1000 };
        if(!snap.exists()) set(ref(db, 'users/' + user.uid), userStats);
        
        document.getElementById('user-photo').src = userStats.photo;
        document.getElementById('user-name').innerText = userStats.name.split(' ')[0];
        document.getElementById('user-coin').innerText = userStats.koin;
        document.getElementById('screen-login').style.display = 'none';
        document.getElementById('screen-lobby').style.display = 'flex';
        listenOnline();
    }

    function setupPresence(user) {
        const statusRef = ref(db, 'status/' + user.uid);
        set(statusRef, { name: user.displayName, photo: user.photoURL, online: true });
        onDisconnect(statusRef).remove();
    }

    window.switchTab = (t) => {
        document.getElementById('tab-play').style.display = t === 'play' ? 'block' : 'none';
        document.getElementById('tab-online').style.display = t === 'online' ? 'block' : 'none';
        document.getElementById('btn-play').style.background = t === 'play' ? '#3498db' : 'rgba(255,255,255,0.1)';
        document.getElementById('btn-online').style.background = t === 'online' ? '#3498db' : 'rgba(255,255,255,0.1)';
    }

    function listenOnline() {
        onValue(ref(db, 'status'), (snap) => {
            const list = document.getElementById('online-list');
            list.innerHTML = "";
            snap.forEach((child) => {
                if(child.key !== currentUser.uid) {
                    const p = child.val();
                    const div = document.createElement('div');
                    div.className = "player-item";
                    div.innerHTML = `<img src="${p.photo}" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                        <div style="flex-grow:1;"><b>${p.name}</b><br><small style="color:#2ecc71;">Online</small></div>
                        <button class="btn-plus" onclick="sendInvite('${child.key}', '${p.name}')">+</button>`;
                    list.appendChild(div);
                }
            });
        });
    }

    window.sendInvite = (uid, name) => {
        const rid = "INV_" + Date.now();
        set(ref(db, 'invites/' + uid), { fromName: userStats.name, fromPhoto: userStats.photo, roomId: rid });
        alert("Mengajak " + name + " main...");
    };

    function listenInvites() {
        onValue(ref(db, 'invites/' + currentUser.uid), (snap) => {
            if(snap.exists()) {
                const d = snap.val();
                window.activeInvite = d;
                document.getElementById('inviter-name').innerText = d.fromName;
                document.getElementById('inviter-photo').src = d.fromPhoto;
                document.getElementById('invite-modal').style.display = 'flex';
            }
        });
    }

    window.acceptInvite = () => {
        const d = window.activeInvite;
        remove(ref(db, 'invites/' + currentUser.uid));
        document.getElementById('invite-modal').style.display = 'none';
        alert("Masuk ke Room: " + d.roomId);
    };

    window.rejectInvite = () => {
        remove(ref(db, 'invites/' + currentUser.uid));
        document.getElementById('invite-modal').style.display = 'none';
    };
    
    window.startBotMode = () => {
        document.getElementById('screen-lobby').style.display = 'none';
        document.getElementById('screen-game').style.display = 'block';
    }
</script>
</body>
</html>
